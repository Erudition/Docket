<!DOCTYPE HTML>
<html>

<head>
  <meta charset="UTF-8">
  <title>Docket</title>
  <link rel="stylesheet" href="styles/style.css">
  <link rel="stylesheet" href="styles/sliders.css">
  <link rel="stylesheet" href="styles/timetracker.css">
</head>

<body>
</body>
<script src="capacitor.js"></script>
<!-- <script type="module" src="https://unpkg.com/@ionic/pwa-elements@latest/dist/ionicpwaelements/ionicpwaelements.esm.js"></script>
<script nomodule src="https://unpkg.com/@ionic/pwa-elements@latest/dist/ionicpwaelements/ionicpwaelements.js"></script> -->

<script type="module" src="https://unpkg.com/@ionic/pwa-elements@1.2.7/dist/ionicpwaelements/ionicpwaelements.esm.js"></script>
<script nomodule="" src="https://unpkg.com/@ionic/pwa-elements@1.2.7/dist/ionicpwaelements/ionicpwaelements.js"></script>
<script type="application/javascript" src="elm-gui.js"></script>
<script type="application/javascript">

//my helper functions:

function getGlobalVar (name) {
    try {
        let g = global(name);
        if (typeof g !== 'undefined')
            return g;
        else {
            logflash(`Failed to get global: ${name} because it was undefined`);
            return null;
        }
    } catch (e) {
        //logflash(`Failed to get global: ${name} because ${e}`);
        return null;
    }
}

function getLocalUrl () {
    if (typeof elmurl !== 'undefined')
        return elmurl;
    else
        logflash(`Failed to get local url because it was undefined`);
        return null;
}

function taskerOut (name, value) {
    try {
        if (name.toLower == name)
          setLocal(name, value);
        else
          setGlobal(name, value);
    } catch (e) {
        logflash("Setting " +name+ " to " +value+ " if tasker was here");
    }
}

function logflash(msg) {
    try {
        flash(msg);
    } catch (e) {
        console.log(msg);
    }
}

function taskerTry (func) {
    try {
        return func();
    } catch (e) {
        //logflash("Tried " + func);
        return null;
    }
}

var storagefilename = "Minder/personal-data.json"

function taskerReadAppData () {
    try {
        return readFile(storagefilename);
        //return getGlobalVar("ElmAppData");
    } catch (e) {
        //logflash("Failed to read file " + file);
        taskerWriteAppData("");
        return ' ';
    }
}

function taskerWriteAppData (data) {
    try {
        writeFile(storagefilename,data,false)
        //return getGlobalVar("ElmAppData");
    } catch (e) {
        //logflash("Failed to read file " + file);
        return ' ';
    }
}

function taskerExit () {
    try {
        exit();
    } catch (e) {
        logflash("Tried to exit");
    }
}
// Elm init
//var storedState = localStorage.getItem('docket-v0.1-data');
//var startingState = storedState ? storedState : null;

var Elm = this.Elm; //trick I discovered to bypass importing



var taskerUrl = getLocalUrl();
var taskerUrl = (taskerUrl != null) ? taskerUrl : "http://docket.com/?start=configure";


// touch file in case it's not There
//taskerTry(() => {writeFile("docket.dat","",true)});

var app = this.Elm.Headless.init(
    { flags: [taskerUrl, taskerReadAppData()] });

//logflash(`Running Elm! \n Url: ${taskerUrl} \n Data: ${taskerReadAppData()}`);

app.ports.variableOut.subscribe(function(data) {
    taskerOut(data[0], data[1]);
});



app.ports.setStorage.subscribe(function(data) {
    //taskerOut("ElmAppData", state);
    //logflash("Storage set!");
    taskerWriteAppData(data);
});


app.ports.flash.subscribe(function(data) {
    logflash(data);
});



app.ports.exit.subscribe(function(data) {
    setTimeout(() => taskerExit(), 10);
});


//setTimeout(sendIt, 1500);

// function sendIt() {
//     app.ports.headlessMsg.send(taskerUrl);
// }

taskerOut("ElmScriptVersion", "70");




</script>


</html>
